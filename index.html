<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Jadual Waktu 6C - SKAG</title>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #39ff14;
            --neon-yellow: #fff200;
            --danger-red: #ff0000;
            --glass-bg: rgba(0, 0, 0, 0.85);
            --card-bg: rgba(10, 10, 15, 0.95);
        }

        /* ANIMASI */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 5px var(--neon-green); }
            50% { box-shadow: 0 0 20px var(--neon-green); }
            100% { box-shadow: 0 0 5px var(--neon-green); }
        }

        @keyframes blinkDanger {
            0% { background: var(--danger-red); opacity: 1; }
            50% { background: #ff5555; opacity: 0.5; }
            100% { background: var(--danger-red); opacity: 1; }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; text-transform: uppercase; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: #050505; color: white;
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        .header-box {
            margin-top: 15px; margin-bottom: 10px;
            background: var(--glass-bg); padding: 15px 30px; border-radius: 15px;
            border: 2px solid var(--neon-blue); box-shadow: 0 0 25px rgba(0, 243, 255, 0.4);
            width: 95%; max-width: 1300px;
        }

        .title-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            width: 100%;
        }

        .title-row h1 {
            grid-column: 2;
            font-size: 1.8rem;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        .clock {
            grid-column: 3;
            justify-self: end;
            color: var(--neon-blue); font-weight: 900; font-size: 1.8rem; 
            background: rgba(0,0,0,0.5); padding: 5px 20px; border-radius: 10px;
            border: 1px solid var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            letter-spacing: 2px;
            min-width: 160px;
            text-align: center;
        }

        .teacher-container {
            display: flex; gap: 15px; justify-content: center; margin-top: 15px; flex-wrap: wrap;
        }
        .teacher-badge {
            background: rgba(0, 243, 255, 0.05); border: 1px solid rgba(0, 243, 255, 0.5);
            padding: 6px 15px; border-radius: 30px; font-size: 0.7rem; display: flex; align-items: center; gap: 10px;
        }
        .teacher-label { color: var(--neon-blue); font-weight: 900; }
        .teacher-input-field {
            background: transparent; border: none; color: var(--neon-yellow);
            font-weight: bold; width: 280px; outline: none; text-align: left; font-size: 0.8rem;
        }

        .content-container {
            width: 98%; max-width: 1400px; flex-grow: 1;
            background: var(--card-bg); border-radius: 20px;
            border: 1px solid rgba(0, 243, 255, 0.2); padding: 10px;
            backdrop-filter: blur(15px); overflow-x: auto; margin-bottom: 10px;
        }

        table { width: 100%; height: 100%; border-collapse: separate; border-spacing: 4px; table-layout: fixed; min-width: 1100px; }
        th { background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); font-size: 0.65rem; padding: 6px; border-radius: 5px; border: 1px solid var(--neon-blue); }
        td { background: rgba(255, 255, 255, 0.03); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1); position: relative; overflow: hidden; }
        
        .active-row td:first-child { 
            background: var(--neon-blue) !important; color: black !important; font-weight: 900; box-shadow: 0 0 15px var(--neon-blue);
        }

        .active-period { border: 3px solid var(--neon-green) !important; animation: pulseGlow 2s infinite ease-in-out; z-index: 10; }

        .progress-container {
            width: 90%; height: 6px; background: rgba(255,255,255,0.1);
            border-radius: 10px; margin: 3px auto; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .progress-bar { height: 100%; width: 0%; background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); transition: width 1s linear; }
        .last-minutes { animation: blinkDanger 0.8s infinite !important; }

        .cell-content { display: flex; flex-direction: column; height: 100%; justify-content: center; position: relative; z-index: 2; }
        .sub-in { font-size: 0.85rem; color: var(--neon-green); height: 40%; font-weight: 900; background: transparent; border: none; text-align: center; outline: none; }
        .teach-in { font-size: 0.5rem; opacity: 0.7; height: 25%; background: transparent; border: none; text-align: center; color: white; outline: none; }
        .rehat-col { background: rgba(255, 0, 85, 0.2) !important; color: var(--neon-pink); font-weight: 900; font-size: 1.5rem; text-align: center; border: 1px solid var(--neon-pink) !important; width: 40px; }

        /* WARNA SUBJEK */
        .color-BM { background: rgba(255, 0, 0, 0.3) !important; border-color: #ff0000 !important; }
        .color-BI { background: rgba(0, 81, 255, 0.3) !important; border-color: #0051ff !important; }
        .color-MT { background: rgba(255, 242, 0, 0.2) !important; border-color: #fff200 !important; }
        .color-SN { background: rgba(0, 255, 30, 0.2) !important; border-color: #00ff1e !important; }
        .color-PAI { background: rgba(0, 234, 255, 0.2) !important; border-color: #00eaff !important; }
        .color-PM { background: rgba(255, 0, 234, 0.2) !important; border-color: #ff00ea !important; }
        .color-BA { background: rgba(162, 0, 255, 0.3) !important; border-color: #a200ff !important; }
        .color-SJ, .color-SEJ { background: rgba(255, 145, 0, 0.3) !important; border-color: #ff9100 !important; }
        .color-PSV { background: rgba(255, 0, 115, 0.25) !important; border-color: #ff0073 !important; }
        .color-MZ { background: rgba(200, 0, 255, 0.2) !important; border-color: #c800ff !important; }
        .color-RBT { background: rgba(139, 69, 19, 0.3) !important; border-color: #8b4513 !important; }
        .color-PJ, .color-PK, .color-PJK { background: rgba(149, 255, 0, 0.2) !important; border-color: #95ff00 !important; }
        .color-PIQPM { background: linear-gradient(135deg, rgba(0, 200, 150, 0.3), rgba(255, 0, 234, 0.3)) !important; border-color: #00ffaa !important; }
        .color-PIUPM { background: linear-gradient(135deg, rgba(0, 255, 100, 0.3), rgba(255, 0, 234, 0.3)) !important; border-color: #00ff64 !important; }

        .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn { padding: 8px 15px; background: transparent; border: 2px solid var(--neon-blue); color: var(--neon-blue); cursor: pointer; border-radius: 10px; font-weight: bold; font-size: 0.75rem; }
        .btn:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); }
        
        #alarmBanner {
            position: fixed; top: -120px; left: 0; width: 100%; background: linear-gradient(90deg, #ff0055, #ff0000);
            color: white; padding: 15px; text-align: center; font-weight: 900; z-index: 4000; transition: 0.6s;
            font-size: 1.1rem; border-bottom: 3px solid white;
        }
        #alarmBanner.active { top: 0; }
    </style>
</head>
<body>

    <div id="alarmBanner">INFO: MEMULAKAN SISTEM...</div>
    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div class="header-box">
        <div class="title-row">
            <div></div> <h1>JADUAL WAKTU 6 CEMERLANG</h1>
            <div id="liveClock" class="clock">00:00:00</div>
        </div>
        
        <div class="teacher-container">
            <div class="teacher-badge">
                <span class="teacher-label">GURU KELAS 1:</span>
                <input type="text" id="teacher1" class="teacher-input-field" placeholder="NAMA GURU 1">
            </div>
            <div class="teacher-badge">
                <span class="teacher-label">GURU KELAS 2:</span>
                <input type="text" id="teacher2" class="teacher-input-field" placeholder="NAMA GURU 2">
            </div>
        </div>
        
        <h2 style="font-size:0.75rem; opacity:0.8; margin-top:10px; text-align:center;">
            <span id="todayDate" style="color:var(--neon-yellow);"></span>
        </h2>
    </div>

    <div class="content-container">
        <table id="ttTable">
            <thead>
                <tr>
                    <th style="width: 80px;">HARI</th>
                    <th>07:10-07:40</th><th>07:40-08:10</th><th>08:10-08:40</th><th>08:40-09:10</th><th>09:10-09:40</th>
                    <th style="width: 40px;">REHAT</th>
                    <th>10:00-10:30</th><th>10:30-11:00</th><th>11:00-11:30</th><th>11:30-12:00</th><th>12:00-12:30</th><th>12:30-01:00</th>
                </tr>
            </thead>
            <tbody id="ttBody"></tbody>
        </table>
    </div>

    <div class="btn-row">
        <button class="btn" onclick="saveToFirebase()">üíæ SIMPAN SEMUA</button>
        <button class="btn" style="border-color:var(--neon-pink); color:var(--neon-pink);" onclick="resetFirebase()">üßπ PADAM DATA</button>
        <button class="btn" onclick="document.documentElement.requestFullscreen()">üñ•Ô∏è SKRIN PENUH</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBtA37bRurRoe7kCTUX_aIQHNv0cjWG09A",
            authDomain: "jadualkelas-896ae.firebaseapp.com",
            databaseURL: "https://jadualkelas-896ae-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jadualkelas-896ae",
            storageBucket: "jadualkelas-896ae.firebasestorage.app",
            messagingSenderId: "164261211870",
            appId: "1:164261211870:web:03eb60e7276601953c1c4f",
            measurementId: "G-QLP6G40QMM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'jadual_6c');

        const hariArr = ['ISNIN', 'SELASA', 'RABU', 'KHAMIS', 'JUMAAT'];
        const rehatTxt = ['R', 'E', 'H', 'A', 'T'];
        const subjekList = ['BM','BI','MT','SN','PAI','PM','SJ','SEJ','PJ','PK','PJK','PSV','MZ','RBT','BA','PIQPM','PIUPM'];
        const slotStarts = [430, 460, 490, 520, 550, 600, 630, 660, 690, 720, 750];
        const slotEnds = [460, 490, 520, 550, 580, 630, 660, 690, 720, 750, 780];
        const AUTH_KOD = "jadualwaktu";
        let alarmTriggered = false;

        window.init = function() {
            const tt = document.getElementById('ttBody');
            tt.innerHTML = ""; 
            hariArr.forEach((h, i) => {
                let rTT = `<tr id="row-${i}">
                    <td style="color:var(--neon-blue); font-weight:900; text-align:center; font-size:0.75rem;">${h}</td>`;
                for(let j=0; j<12; j++) {
                    if(j === 5) {
                        rTT += `<td class="rehat-col">${rehatTxt[i]}</td>`;
                    } else {
                        rTT += `<td class="slot-cell" data-day="${i}" data-slot="${j}">
                            <div class="cell-content">
                                <input type="text" class="sub-in tt-in" oninput="applyColor(this)" placeholder="-">
                                <input type="text" class="teach-in tt-in" placeholder="GURU">
                            </div>
                        </td>`;
                    }
                }
                rTT += `</tr>`;
                tt.innerHTML += rTT;
            });

            onValue(dbRef, (snapshot) => {
                const d = snapshot.val();
                if (!d) return;
                if(d.t1) document.getElementById('teacher1').value = d.t1;
                if(d.t2) document.getElementById('teacher2').value = d.t2;
                const ttIn = document.querySelectorAll('.tt-in');
                d.tt?.forEach((v, i) => { 
                    if(ttIn[i]) {
                        ttIn[i].value = v;
                        if(ttIn[i].classList.contains('sub-in')) applyColor(ttIn[i]);
                    }
                });
            });
            setInterval(runSystem, 1000);
        }

        window.applyColor = (el) => {
            let val = el.value.trim().toUpperCase().replace(/\s+/g, '');
            if (val.includes('PIQ/PM')) val = 'PIQPM';
            else if (val.includes('PIU/PM')) val = 'PIUPM';
            else if (val === 'SEJARAH') val = 'SEJ';
            else if (val.includes('PJ')) val = 'PJK';
            const td = el.closest('td');
            subjekList.forEach(s => td.classList.remove(`color-${s}`));
            if (subjekList.includes(val)) td.classList.add(`color-${val}`);
        };

        function runSystem() {
            const now = new Date();
            
            // Format jam manual supaya lebih stabil pada Rasp Pie
            const jam = now.getHours().toString().padStart(2, '0');
            const min = now.getMinutes().toString().padStart(2, '0');
            const saat = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('liveClock').innerText = jam + ":" + min + ":" + saat;
            
            try {
                document.getElementById('todayDate').innerText = now.toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            } catch(e) {
                document.getElementById('todayDate').innerText = now.toDateString();
            }

            const currentMins = now.getHours() * 60 + now.getMinutes();
            const currentDay = now.getDay() - 1; // Isnin=0, Ahad=-1

            // RESET GAYA LAMA
            document.querySelectorAll('.slot-cell').forEach(c => {
                c.classList.remove('active-period');
                const oldBar = c.querySelector('.progress-container');
                if(oldBar) oldBar.remove();
            });
            document.querySelectorAll('#ttBody tr').forEach(row => row.classList.remove('active-row'));

            // LOGIK HARI MINGGU
            if (currentDay < 0 || currentDay > 4) {
                document.getElementById('alarmBanner').classList.remove('active');
                return; 
            }

            // HIGHLIGHT HARI INI
            const rowToday = document.getElementById(`row-${currentDay}`);
            if(rowToday) rowToday.classList.add('active-row');

            // LOGIK SLOT MASA
            slotStarts.forEach((start, idx) => {
                const end = slotEnds[idx];
                if (currentMins >= start && currentMins < end) {
                    const visualSlot = idx >= 5 ? idx + 1 : idx;
                    const activeCell = document.querySelector(`.slot-cell[data-day="${currentDay}"][data-slot="${visualSlot}"]`);
                    
                    if (activeCell) {
                        activeCell.classList.add('active-period');
                        const subIn = activeCell.querySelector('.sub-in');
                        const currentSub = subIn ? subIn.value : "-";
                        
                        const total = end - start;
                        const elapsed = currentMins - start;
                        const percent = (elapsed / total) * 100;
                        const timeLeft = end - currentMins;

                        // Tambah Progress Bar
                        if(!activeCell.querySelector('.progress-container')) {
                            let pContainer = document.createElement('div');
                            pContainer.className = 'progress-container';
                            const blinkClass = (timeLeft <= 5) ? 'last-minutes' : '';
                            pContainer.innerHTML = `<div class="progress-bar ${blinkClass}" style="width:${percent}%"></div>`;
                            activeCell.querySelector('.cell-content').appendChild(pContainer);
                        } else {
                            activeCell.querySelector('.progress-bar').style.width = percent + "%";
                            if(timeLeft <= 5) activeCell.querySelector('.progress-bar').classList.add('last-minutes');
                        }

                        // Alarm Banner
                        const banner = document.getElementById('alarmBanner');
                        if(timeLeft <= 5 && currentSub !== "-" && currentSub !== "") {
                            banner.innerText = `‚ö†Ô∏è ${currentSub} TAMAT DALAM ${timeLeft} MINIT!`;
                            banner.classList.add('active');
                            if(!alarmTriggered) {
                                document.getElementById('alarmSound').play().catch(() => {});
                                alarmTriggered = true;
                            }
                        } else {
                            banner.classList.remove('active');
                            alarmTriggered = false;
                        }
                    }
                }
            });
        }

        window.saveToFirebase = () => {
            if (prompt("KOD AKSES:") !== AUTH_KOD) return alert("KOD SALAH!");
            const data = { 
                tt: Array.from(document.querySelectorAll('.tt-in')).map(i => i.value),
                t1: document.getElementById('teacher1').value,
                t2: document.getElementById('teacher2').value
            };
            set(dbRef, data).then(() => alert("‚úÖ DISIMPAN!"));
        };

        window.resetFirebase = () => {
            if (prompt("KOD PADAM:") !== AUTH_KOD) return alert("KOD SALAH!");
            if(confirm("PADAM SEMUA?")) remove(dbRef).then(() => location.reload());
        }

        init();
    </script>
</body>
</html>
